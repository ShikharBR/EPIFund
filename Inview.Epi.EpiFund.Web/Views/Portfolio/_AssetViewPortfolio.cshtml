@using PagedList.Mvc
@model List<Inview.Epi.EpiFund.Domain.ViewModel.AdminAssetQuickListModel>


<div class="modal-header">   
    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
    <h4 class="modal-title" style="text-align:center;" >[ @Model.Count.ToString() result(s) found]</h4>
    <h5>
        If you select Pricing Display Option as "Submit Offer" or "CMV" then LP will be entered as zero.
    </h5>
    <h5>Pricing Display Option : <span id="PricingDisplayOptionDisplay"></span> </h5>
</div>

<div class="modal-body">
    <div class="row">
        <div class="panel panel-default" style="border: 1px solid #B1A795;">
            @if (Model != null && Model.Count > 0)
            {
                <div class="overflow short-xs">
                    <table class="table table-striped" id="tbAssets" cellpadding="1" cellspacing="1"
                           style="font-size: 10px !important; padding: 1px; vertical-align: middle;">
                        <thead>
                            <tr>
                                <th></th>
                                <th><b>Asset ID#</b></th>
                                <th><b>Asset Name</b></th>
                                <th><b>Asset Type</b></th>
                                <th><b>Current LP</b></th>
                                <th><b>Current<br />CMV/CMA</b></th>
                                <th><b>Portfolio CAP<br />Rate</b></th>
                            </tr>
                        </thead>
                        <tbody>
                            @for (int i = 0; i < @Model.Count; i++)
                            {
                                <tr>
                                    <td>@(i+1)</td>
                                    <td>
                                        <a href="@Url.Action("ViewAsset", "DataPortal", new { id = @Model[i].AssetId, fromManageAssets = true })">
                                            @Model[i].AssetNumber
                                        </a>

                                        
                                        <input type="hidden" id="TotalUnits_@Model[i].AssetId" value="@Model[i].TotalUnits" />
                                        <input type="hidden" id="EstDeferredMaintenance_@Model[i].AssetId" value="@Model[i].EstDeferredMaintenance" />
                                        <input type="hidden" id="ProformaAnnualOperExpenses_@Model[i].AssetId" value="@Model[i].ProformaAnnualOperExpenses" />
                                        <input type="hidden" id="ProformaAnnualIncome_@Model[i].AssetId" value="@Model[i].ProformaAnnualIncome" />
                                        <input type="hidden" id="ProformaMiscIncome_@Model[i].AssetId" value="@Model[i].ProformaMiscIncome" />
                                        <input type="hidden" id="ProformaVacancyFac_@Model[i].AssetId" value="@Model[i].ProformaVacancyFac" />
                                        <input type="hidden" id="AssetType_@Model[i].AssetId" value="@Model[i].Type" />
                                        <input type="hidden" id="AverageAdjustmentToBaseRentalIncomePerUnitAfterRenovations_@Model[i].AssetId" value="@Model[i].AverageAdjustmentToBaseRentalIncomePerUnitAfterRenovations" />

                                    </td>
                                    <td style="word-wrap:break-word;">
                                        <a onclick="EditAsset('@Model[i].AssetId')" style="cursor:pointer">
                                            <span class="AssetName" title="@Model[i].AssetName">
                                                @Model[i].AssetName
                                            </span>
                                        </a>
                                    </td>
                                    <td>
                                        @Model[i].Type
                                    </td>
                                    <td>
                                        <input type="text" onblur="calcTotalCapRate(this)" onchange="addCommasToInput(this)" class="formatNumber" id="txtLP_@Model[i].AssetId" value="@Model[i].AskingPrice" />
                                    </td>
                                    <td>
                                        <input type="text" onblur="calcTotalCapRate(this)" onchange="addCommasToInput(this)" class="formatNumber" id="txtCMV_@Model[i].AssetId" value="@Model[i].CurrentBpo" />
                                    </td>
                                    <td id="capRate_@Model[i].AssetId">
                                        @if (Model[i].AskingPrice > 0)
                                        {
                                            @((Model[i].CashInvestmentApy / 100).ToString("P2"))
                                        }
                                        else
                                        {
                                            @((Model[i].capRate / 100).ToString("P2"))
                                        }
                                    </td>
                                </tr>
                            }
                            <tr>
                                <td>&nbsp;</td>
                                <td>&nbsp;</td>
                                <td>&nbsp;</td>
                                <td>Total:</td>
                                <td id="TotalLP">
                                    <span class="padmoney" id="AskingPriceTotal">@Model.Sum(a => a.AskingPrice).ToString("C0")</span>
                                </td>
                                <td id="TotalCMV">
                                    <span class="padmoney" id="CurrentBpoTotal">@Model.Sum(a => a.CurrentBpo).ToString("C0")</span>
                                </td>
                                <td>
                                    <span class="padmoney" id="AvgCapRate"></span>
                                    
                                </td>
                            </tr>
                            <tr>
                                <td colspan="6"></td>
                                <td>
                                    <input type="button" id="btnSave" class="btn btn-primary" value="Save">
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            }
        </div>
    </div>
</div>

<script>

    function calcTotalCapRate(element) {

        //sum of LP and CMV
        var sumLP = 0;
        var sumCMV = 0;
        $("input[id*='txtLP_']").each(function (i, el) {
            sumLP += parseInt($(this).val().replaceAll(',', ''));
        });

        $("input[id*='txtCMV_']").each(function (i, el) {
            sumCMV += parseInt($(this).val().replaceAll(',', ''));
        });

        var strLp = sumLP.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        var strLmv = sumCMV.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        $('#AskingPriceTotal').html("$" + strLp);
        $('#CurrentBpoTotal').html("$" + strLmv);

        //cap rate calulation        
        var id = $(element).attr('id');
        var id = id.split('_')[1];

        var aoe = getNumberFromValue($('#ProformaAnnualOperExpenses_' + id).val());
        var pagi = getNumberFromValue($('#ProformaAnnualIncome_' + id).val());
        var pami = getNumberFromValue($('#ProformaMiscIncome_' + id).val());
        var vf = getNumberFromValue($('#ProformaVacancyFac_' + id).val());
        
        var totalIncome = pagi + pami;

        var pvf = (vf / 100) * totalIncome;
        var pretax = Math.round((totalIncome - pvf) - aoe);
        
        var assetType = $('#AssetType_' + id).val();
        if (assetType == "MF" || assetType == "MHP") {

            var EstDeferredMaintenance = getNumberFromValue($('#EstDeferredMaintenance_' + id).val());
            var AverageAdjustmentToBaseRentalIncomePerUnitAfterRenovations = getNumberFromValue($('#AverageAdjustmentToBaseRentalIncomePerUnitAfterRenovations_' + id).val());
            var units = getNumberFromValue($('#TotalUnits_' + id).val());
            var defAnnualRevenueAdjustment = EstDeferredMaintenance == 0 ? 0 : (AverageAdjustmentToBaseRentalIncomePerUnitAfterRenovations * units * 12);
            var defProformaSGI = EstDeferredMaintenance == 0 ? pagi : pagi + defAnnualRevenueAdjustment + pami;
            var adjDefPvf = (vf / 100) * defProformaSGI;
            var defProformaNOI = EstDeferredMaintenance == 0 ? pretax : Math.round(defProformaSGI - adjDefPvf - aoe);
            
            var PricingDisplayOption = $("#PricingDisplayOption").val();
            if (PricingDisplayOption == "SubmitOffer" || PricingDisplayOption == "Cmv") {

                //SubmitOffer,cmv
                var cmv = getNumberFromValue($('#txtCMV_' + id).val());
                var calc = ((defProformaNOI / cmv) * 100).toFixed(2);

                $("#capRate_" + id).html(addCommas(calc.toString(), true) + '%');
            }
            else if (PricingDisplayOption == "Lp") {
                //lp
                var lp = getNumberFromValue($('#txtLP_' + id).val());
                var calc = ((defProformaNOI / lp) * 100).toFixed(2);
                $("#capRate_" + id).html(addCommas(calc.toString(), true)+'%');
            }              

        }
        else {

            var defProformaNOI = pretax;

            var PricingDisplayOption = $("#PricingDisplayOption").val();
            if (PricingDisplayOption == "SubmitOffer" || PricingDisplayOption == "Cmv") {
                //SubmitOffer,cmv
                var cmv = getNumberFromValue($('#txtCMV_' + id).val());
                var calc = ((defProformaNOI / cmv) * 100).toFixed(2);
                $("#capRate_" + id).html(addCommas(calc.toString(), true) + '%');
            }
            else if (PricingDisplayOption == "Lp") {
                //lp
                var lp = getNumberFromValue($('#txtLP_' + id).val());
                var calc = ((defProformaNOI / lp) * 100).toFixed(2);
                $("#capRate_" + id).html(addCommas(calc.toString(), true) + '%');
            }            
            
        }

        //sum and devided by count
        var sumCapRate = 0;
        var count = 0;
        $("td[id*='capRate_']").each(function (i, el) {
            count = i + 1;
            sumCapRate += parseFloat(getNumberFromValue($(this).html()));
        });

        $('#AvgCapRate').html((sumCapRate / count).toFixed(2) + '%');
        
    }


    $("#btnSave").click(function (e) {

        //validate all the text boxes 
        var valid = true;
        var PricingDisplayOption = $("#PricingDisplayOption").val();
        if (PricingDisplayOption == "SubmitOffer") {
            $("input[id*='txtCMV_']").each(function (i, el) {
                if ($(this).val() == null || $(this).val() == '' || parseInt($(this).val()) == 0) {                    
                    $(this).attr('style', 'border-color:red');
                    onInputBlur($(this).attr('id'));
                    if (valid)
                        valid = false;
                }
            });            
        }
        else if (PricingDisplayOption == "Lp") {
            $("input[id*='txtLP_']").each(function (i, el) {                
                if ($(this).val() == null || $(this).val() == '' || parseInt($(this).val()) == 0) {
                    $(this).attr('style', 'border-color:red');
                    onInputBlur($(this).attr('id'));
                    if (valid)
                        valid = false;
                }
            });
            $("input[id*='txtCMV_']").each(function (i, el) {
                if ($(this).val() == null || $(this).val() == '' || parseInt($(this).val()) == 0) {
                    $(this).attr('style', 'border-color:red');
                    onInputBlur($(this).attr('id'));
                    if (valid)
                        valid = false;
                }
            });
        }
        else if (PricingDisplayOption == "Cmv") {
            $("input[id*='txtCMV_']").each(function (i, el) {
                if ($(this).val() == null || $(this).val() == '' || parseInt($(this).val()) == 0) {
                    $(this).attr('style', 'border-color:red');
                    onInputBlur($(this).attr('id'));
                    if (valid)
                        valid = false;
                }
            });
        }

        if (valid) {
            if (confirm("Would you like to save 'porfolio'; it will also impact all porfolio assets.")) {
                var allElements = [];
                $("input[id*='txtLP_']").each(function (i, el) {
                    var idd = $(this).attr('id');
                    var id = idd.split('_')[1];
                    var lp = $(this).val().replaceAll(',', '');
                    var cmv = $('#txtCMV_' + id).val().replaceAll(',', '');
                    var tab = id + '_' + lp + '_' + cmv;
                    allElements.push(tab);
                });
                $("#AssetIdsLpCMV").val(allElements);
                $("#UpdatePortfolioform").submit();
            }
        }

    });
</script>
